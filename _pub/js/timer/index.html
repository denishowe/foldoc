<!DOCTYPE html>
<!-- saved from url=(0014)about:internet -->
<!--
	Display a countdown from a number of seconds given in the query string
-->

<html>
<head>
<title>Timer</title>
<meta charset="UTF-8">
<link rel="canonical" href="https://foldoc.org/pub/js/timer/">
<style type="text/css">

body {
  overflow: hidden; /* Prevent scrollbars with no margin */
  font-family: Helvetica, "Trebuchet MS", Verdana, sans-serif;
}

a {
  display: inline-block;
  width: 3em;
  height: 1.2em;
  text-align: center;
  margin: 5px;
  border: 1px solid grey;
  padding: 5px;
  border-radius: 12px;
  background-color: #fef;
  text-decoration: none;
}

.controls { font-size: 2.5vw }

.options { line-height: 40pt }

.options-icon {
	position: absolute;
	top: 22px;
	left: 70px;
	font-size: 2.8vw;
}

@keyframes change { to { transform: rotate(360deg); color: red } }

.pulsing {
	left: 65px;
	font-size: 3.5vw;
  animation-name: change;
  animation-duration: 2s;
	animation-timing-function: linear;
	animation-direction: alternate;
  animation-iteration-count: infinite;
}

.times { display: inline }

.timer {
  display: none;
  width: 100%;
}

.time {
  text-align: center;
  color: darkblue;
}

.time {
  font-size: 18vw;
}

.sep {
  font-size: 6vw;
}

</style>
</head>
<body>
<div class="controls">
  <a class="options" href="#"><div class="options-icon">&#9881;</div>&nbsp;</a>
	<div class="times">
		<a href="?5">5s</a>
		<a href="?10">10s</a>
		<a href="?20">20s</a>
		<a href="?30">30s</a>
		<a href="?60">1m</a>
		<a href="?120">2m</a>
		<a href="?300">5m</a>
		<a href="?600">10m</a>
		<a href="?1200">20m</a>
		<a href="?1800">30m</a>
		<a href="?3600">1h</a>
		<a href="?86400">1d</a>
		<a href="?2592000">1m</a>
		<a href="?31104000">1y</a>
	</div>
</div>
<div class="timer"><div class="time"></div></div>
<script>

class Timer {
	constructor() {
		this.bindMethods();

		this.optionsIcon = this.el('.options-icon');
		this.el('.options').onclick = this.optionsClicked;

		// chrome://flags/#autoplay-policy
		this.audio = new Audio('ding.wav');
		this.dingsTotal = 3;

		this.start(parseFloat(this.queryString()));
	}

	start(secs) {
		if (isNaN(secs)) return;
		this.toggleTimes(true);
		this.show('.timer', true);
		this.endMs = 1E3 * Math.floor(this.nowMs()/1E3 + secs + 1);
		this.allowNotify();
		this.schedule();
	}

	bindMethods() {
		['alert', 'optionsClicked', 'update']
			.forEach(m => this[m] = this[m].bind(this));
	}

	schedule() {
		const msToNextSecond = 1E3 - this.nowMs() % 1E3;
		setTimeout(this.update, msToNextSecond);
	}

	update() {
		let secsLeft = Math.floor((this.endMs - this.nowMs() + 999) / 1E3); // Seconds to go
		if (secsLeft < 0) { this.timeExpired(); return }
		const s = this.secsToString(secsLeft);
		document.title = s.replace('<br>', ' ').replace(/ : /g, ':');
		const htmlTime = s.replace(/(\D+)/g, '<span class="sep">$1</span>');
		this.els('.time').forEach(e => e.innerHTML = htmlTime);
		this.schedule();
	}

	secsToString(n) {
		const bases = [Infinity, 12, 30, 24, 60, 60];  // Modulos for y, m, d, h, m, s
		const seps = [ 'y ', 'm ', 'd<br>', ' : ', ' : ', '' ];
		let s = '';
		do {
			s = seps.pop() + s;
			const base = bases.pop();
			const part = n % base;
			s = (base <= 60 && part < 10 ? '0' : '') + part + s;
			n = Math.floor(n / base);
		} while (n);

		return s;
	}

	timeExpired() { this.setAlert(true) }

	optionsClicked() {
		this.setAlert(false);
		this.toggleTimes();
	}

	setAlert(on) {
		this.animateOptionsButton(on);
		this.notify(on);
		this.toggleTitle(true);
		this.dings = on ? this.dingsTotal : 0;
		if (on) this.alert();
	}

	alert() {
		if (--this.dings >= 0)
			this.audio.play().catch(e => {});	// Catch Chrome fail
		this.toggleTitle();
		setTimeout(this.alert, 2E3);
	}

	toggleTimes(hide) {
		this.show('.times a', this.showTimes = ! (hide || this.showTimes));
	}

	nowMs() { return (new Date).getTime() }

	queryString() { return location.search.substr(1) }

	show(sel, showHide) {
		this.els(sel).forEach(e => e.style.display = showHide ? 'inline-block' : 'none');
	}

	els(selector) { return document.querySelectorAll(selector) }

	el(selector) { return this.els(selector)[0] }

	// https://developer.mozilla.org/en-US/docs/Web/API/Notifications_API/

	allowNotify() {
		if (Notification.permission !== 'granted')
			Notification.requestPermission();
	}

	notify(on) {
		if (! on && this.notification ) { this.notification.close(); return }
		const body = "Time's up!";
		const icon = 'reaper.jpg';
		this.notification = new Notification('Timer expired', { body, icon });
		this.notification.onclick = () => this.setAlert(false);
		// There's no way to tell whether onclose was the user
		// closing a notification or Firefox autoclosing it after 10s
	}

	toggleTitle() {
		this.titleState = ! this.titleState;
		document.title = this.titleState ? 'time up' : 'TIME UP';
	}

	animateOptionsButton(on) {
		const method = on ? 'add' : 'remove';
		this.optionsIcon.classList[method]('pulsing');
	}
}

new Timer();

</script>
</body>
</html>
