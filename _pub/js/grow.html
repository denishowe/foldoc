<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<author>Denis Howe</author>
<date>2019-08-03 - 2019-08-03</date>
<title>Grow</title>
<link rel="canonical" href="http://foldoc.org/pub/js/grow.html">
<style type="text/css">
  body {
    overflow: hidden; /* Prevent scrollbars with no margin */
    background-color: black;
  }
</style>
</head>
<body>
<canvas id="canvas"></canvas>
<script>
'use strict';

const size = 1 << rand(0, 4); // console.log('size', size);
const drawSize = size; // - (size < 3 ? 0 : 1);

const { xMax, yMax, ctx } = createCanvas();

const neighbour = [ [1,0], [0,1], [-1,0], [0,-1] ].map( vxy => ({ nx: vxy[0], ny: vxy[1] }) );

for (let y = 0; y < yMax; y++) {
  screen[y] = [];
  for (let x = 0; x < xMax; x++) {
    drawDot(x, y, screen[y][x] = randomColour());
  }
}

function growPoint() {
  for (let i = 1E4; i--; ) {
    const { rx, ry } = randomPoint();
    grow(rx, ry);
  }
}

function grow(sx, sy) {
  const c = screen[sy][sx];
  const { nx, ny } = neighbour.any();
  const x = (sx + nx + xMax) % xMax;
  const y = (sy + ny + yMax) % yMax;
  screen[y][x] = c;
  drawDot(x, y, c);
  if (p(1E-5)) seed(); // 1E-6
}

function seed() {
  const { rx, ry } = randomPoint();
  const c = randomColour();
  screen[ry][rx] = c;
  drawDot(rx, ry, c);
}

function loop(f) { f(); setTimeout(() => loop(f), 0) }

function run() { loop(growPoint) }

function randomPoint() { return { rx :rand(0, xMax), ry: rand(0, yMax) } }

function createCanvas() {
  const can = document.getElementById("canvas");
  const w = window.innerWidth;
  const h = window.innerHeight;
  const xMax = Math.floor(w / size);
  const yMax = Math.floor(h / size);
  can.width = size * xMax;
  can.height = size * yMax;
  can.style.marginLeft = (w - can.width) / 2 - 8 + 'px';
  can.style.marginTop = (h - can.height) / 2 - 8 + 'px';
  document.body.appendChild(can);

  return { xMax, yMax, ctx: can.getContext('2d') };
}

function drawDot(x, y, c) {
  ctx.fillStyle = hex(c);
  ctx.fillRect(size*x, size*y, drawSize, drawSize);
}

Array.prototype.any = function any() { return this[rand(0, this.length)] }

// Return a random integer, min <= x < max

function rand(min, max) { return Math.floor(min + (max - min) * Math.random()); }

function p(probability) { return Math.random() < probability }

function hex(x) { return "#" + ((0x1000000 + x).toString(16)).substr(-6) }

function randomColour() { return 0x10000 * rndCpt() + 0x100 * rndCpt() + rndCpt() }
function rndCpt() { return 0x11 * rand(0, 16) }

function nOf(n, f) {
  const result = [];
  while (n-- > 0)
	result.push(f());
  return result;
}

run();
</script>
</body>
</html>
