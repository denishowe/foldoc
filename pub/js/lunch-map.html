<!DOCTYPE html>
<html>
<head>
  <title>Lunch</title>
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
  <meta charset="utf-8">
  <style>
    html, body, #map { margin: 0; padding: 0; height: 100% }
    #control {
	  position: absolute; top: 9px; left: 178px;
	  height: 20px;
	  padding: 10px;
	  border: 1px solid grey; border-radius: 2px;
	  background-color: white;
	  font-family: Roboto, Arial, sans-serif; font-weight: 500;
	  color: #888888;
	  cursor: pointer;
	}
  </style>

  <script>
'use strict';

function initMap() {

  // https://developers.google.com/maps/documentation/javascript/
  // apiKey = 'AIzaSyA5kT5488ytqIeJUPg6MJgE_NejzGvELRA';
  // https://www.google.com/maps/d/u/0/embed?mid=1S6TpY0cG3zxhIQ7zJSB_1HVGADhDZpma

  mapPlaces().then(places => {
	const origin = places[0];

	const mapDiv = document.getElementById('map');
	const map = new google.maps.Map(mapDiv, { mapTypeId: 'roadmap', center: origin, zoom: 15 });

	places.forEach(p => {
	  p.bearing = bearing(origin, p);
	  showPlace(map, origin, p);
	});

	const bearings = places.map(p => p.bearing);
	const targetBearing = splitMaxDiff(bearings);
	const target = pointOn(origin, targetBearing);

	console.log(dp(target.lat) + ',' + dp(target.lng));

	new google.maps.Polyline({map, path: [origin, target], strokeColor: '#FF44FF', strokeWeight: 2});
  });
  const controlDiv = document.getElementById('control');
  controlDiv.onclick = e => location = 'https://www.google.com/maps/d/u/0/edit?hl=en&mid=1S6TpY0cG3zxhIQ7zJSB_1HVGADhDZpma&ll=51.52188783045966%2C-0.08890248334353146&z=16';
}

// Return a map's places {lat, lng, name, description}

function mapPlaces() {
  const mapId = '1S6TpY0cG3zxhIQ7zJSB_1HVGADhDZpma';	// Lunch
  const url = 'https://www.google.com/maps/d/kml?forcekml=1&mid=' + mapId + '&' + Date.now();
  return fetch(url)
  .catch(error => console.log(url, 'FAIL', error))
  .then(response => response.text())
  .then(text => (new DOMParser()).parseFromString(text, "text/xml"))
  .then(xml => {
	// <kml>
	//   <Document>
	//   	 <Placemark>
	//   	 	<name>Bad Egg</name>
	//   	 	<description>2018-11-06 Julius</description>
	//   	 	<styleUrl>#icon-1530-FF5252</styleUrl>
	//   	 	<Point><coordinates>-0.0897608,51.5192017,0</coordinates></Point>
	//   	 </Placemark>

	const placemarks = els(el(el(xml, "kml"), "Document"), "Placemark");

	return placemarks.map(placePoint).filter(x => x);
  });
}

// Given a

// <Placemark>
// 	<name>Bad Egg</name>
// 	<description>2018-11-06 Julius</description>
// 	<styleUrl>#icon-1530-FF5252</styleUrl>
// 	<Point><coordinates>-0.0897608,51.5192017,0</coordinates></Point>
// </Placemark>

// return a place {lat, lng, name, description}
// or undefined if the Placemark has no Point.

function placePoint(placemark) {
  const pp = el(placemark, "Point");
  if (!pp) return;

  const [lng, lat] = elt(pp, "coordinates").split(/,/).map(parseFloat);
  const name = elt(placemark, "name").replace('\n', '');
  const description = elt(placemark, "description");

  return {lat, lng, name, description};
}

function showPlace(map, origin, p) {
  const burger = 'https://mt.google.com/vt/icon/name=icons/onion/SHARED-mymaps-container-bg_4x.png,icons/onion/SHARED-mymaps-container_4x.png,icons/onion/1530-burger_4x.png&highlight=ff000000,FF5252,ff000000';
  const pound = 'https://mt.google.com/vt/icon/name=icons/onion/SHARED-mymaps-container-bg_4x.png,icons/onion/SHARED-mymaps-container_4x.png,icons/onion/1514-bank-pound_4x.png&highlight=ff000000,558b2f,ff000000';
  const bearing = p.bearing;
  const icon = { url: bearing ? burger : pound, anchor: new google.maps.Point(16, 16) };
  const title = p.name + '\n' + p.description;
  const marker = new google.maps.Marker({map, position: p, title, icon, cursor: 'grab'});
  // marker.addListener('click', e => console.log('Click', e));
  if (!bearing) return;

  new google.maps.Polyline(
	{map, path: [origin, p], strokeColor: '#FF0000', strokeWeight: 1, strokeOpacity: 0.5});
  new google.maps.Polyline({map, path: [p, pointOn(origin, bearing)],
							strokeColor: '#FF8888', strokeWeight: 1, strokeOpacity: 0.3});
}

// Given the origin and a place, return the place's bearing from
// the origin.  Bearing is 0..360 degrees clockwise from North.
// https://en.wikipedia.org/wiki/Bearing_(navigation)

function bearing({lat: lat1d, lng: lng1d}, {lat: lat2d, lng: lng2d}) {

  // https://www.movable-type.co.uk/scripts/latlong.html
  // psi = lat (N of equator),  lambda = lng (E of Greenwich)

  const [lat1, lng1, lat2, lng2] = [lat1d, lng1d, lat2d, lng2d].map(rad);
  const deltaLng = lng2 - lng1 // E-W diff
  const x = Math.sin(deltaLng) * Math.cos(lat2)
  const y = Math.cos(lat1) * Math.sin(lat2)
		  - Math.sin(lat1) * Math.cos(lat2) * Math.cos(deltaLng)
  const angle = Math.atan2(x, y)

  // atan2(x, y) is ±π radians clockwise from +ve y axis

  return (deg(angle) + 360) % 360;
}

// Return {lat=N, lng=E} of a point on bearing from the origin

function pointOn(origin, bearing) {
  const bearingRad = rad(bearing);

  const lat1 = rad(origin.lat), lng1 = rad(origin.lng);
  const m = 1500;			 	// Metres from origin
  const dist = 157E-9 * m;		// Angular distance from origin
  const latDest = Math.asin(Math.sin(lat1) * Math.cos(dist)
				          + Math.cos(lat1) * Math.sin(dist) * Math.cos(bearingRad));
  const lngDest = lng1 + Math.atan2(Math.sin(bearingRad) * Math.sin(dist) * Math.cos(lat1),
					                Math.cos(dist) - Math.sin(lat1) * Math.sin(latDest));
  const lat = deg(latDest), lng = deg(lngDest);

  return {lat, lng};
}

// Return the bearing half way between the two consecutive bearings with the
// greatest difference

function splitMaxDiff(bearings) {
  bearings.sort((a, b) => a-b)
  const n = bearings.length
  bearings.push(bearings[0] + 360)		// Next one round for last bearing
  let maxBearing = 0, maxDiff = 0
  bearings.forEach((b, i) => {
	if (i == 0 || i == n) return
	const d = bearings[i+1]-b
	if (d < maxDiff) return
	maxBearing = b
	maxDiff = d
  })
  const mid = maxBearing + 0.5*maxDiff	// Split the biggest difference
  console.log(dp(maxBearing), '+ 0.5 *', dp(maxDiff), '=', dp(mid))

  return mid;
}

function els(node, tag) { return Array.from(node.getElementsByTagName(tag)) }
function el(node, tag) { return els(node, tag)[0] }
function elt(node, tag) { const n = el(node, tag); return n ? n.textContent : '' }

function rad(d) { return d * Math.PI / 180 }
function deg(r) { return r * 180 / Math.PI }
function dp(n) { return n.toLocaleString(undefined,
  {minimumFractionDigits: 4, maximumFractionDigits: 4, minimumIntegerDigits: 3}) }

// https://developers.google.com/maps/documentation/javascript/examples/layer-kml
// const mid = '1S6TpY0cG3zxhIQ7zJSB_1HVGADhDZpma';
// const url = 'http://www.google.com/maps/d/kml?mid=' + mid;
// const kml = new google.maps.KmlLayer({ url, map });

  </script>
</head>
<body>
  <div id="map"></div>
  <div id="control">Edit</div>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA5kT5488ytqIeJUPg6MJgE_NejzGvELRA&callback=initMap" async defer></script>
</body>
</html>
